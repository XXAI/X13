<section fxLayout="column" style="height: 100%; overflow: hidden; flex: 1 1 0%;" (document:keydown.escape)="cancelarAccion()"> <!-- Main Body <<<<<<< -->
    <section fxFlex="none" class="salida-toolbar"> <!-- Toolbar Menu <<<<<<< -->
        <div fxLayout="row">
            <div fxFlex="none" class="label-info">
                <mat-icon>pageview</mat-icon> Detalles del Articulo
            </div>
            <div fxFlex="none" class="label-info" *ngIf="datosFiltrados">
                [ Lote: {{ (data.datosFiltroAplicado.datos_stock.lote)?data.datosFiltroAplicado.datos_stock.lote:'SL' }} | Caducidad: {{ (data.datosFiltroAplicado.datos_stock.fecha_caducidad)?data.datosFiltroAplicado.datos_stock.fecha_caducidad:'SC' }} ]
            </div>
            <button fxFlex="none" mat-button *ngIf="datosFiltrados" (click)="cargarDatosSinFiltro()"><mat-icon>refresh</mat-icon> <span>Recargar sin filtro</span></button>
            <div fxFlex>
            </div>
            <div fxFlex="none" *ngIf="datosArticulo && datosArticulo.deleted_at" class="label-info-delete">
                Eliminado: {{datosArticulo.deleted_at | date}}
            </div>
            <div fxFlex>
            </div>
            <div fxFlex="none" class="label-info">
                <mat-icon class="small-icon" *ngFor="let nivel of nivelesEscape">circle</mat-icon>
            </div>
            <button fxFlex="none" class="boton-accion" mat-button (click)="cerrar()"><mat-icon>close</mat-icon> Cerrar</button>
        </div>
        <mat-progress-bar *ngIf="isLoading" mode="indeterminate" [color]="'primary'"></mat-progress-bar>
    </section> <!-- <<<<<<< Toolbar Menu -->
    <section fxFlex fxLayout="column" style="padding: 10px;">
        <div fxFlex="none" fxLayout="row" fxLayoutGap="5px" [style.fontSize.px]="15">
            <mat-card fxFlex fxLayout="row raw"  fxLayoutGap="5px" *ngIf="datosArticulo" class="datos-articulo">
                <div fxFlex class="fake-input">
                    <span class="label">Clave:</span>
                    <span class="value">{{datosArticulo.clave_local}}</span>
                </div>
                <div fxFlex class="fake-input">
                    <span class="label">Familia:</span>
                    <span class="value">{{datosArticulo.familia}}</span>
                </div>
                <div fxFlex class="fake-input">
                    <span class="label">Partida Especifica:</span>
                    <span class="value">{{datosArticulo.clave_partida_especifica}} - {{datosArticulo.partida_especifica}}</span>
                </div>
                <div fxFlex="100" class="fake-input">
                    <span class="label">Especificaciones:</span>
                    <span class="value-text">{{datosArticulo.especificaciones}}</span>
                </div>
                <div fxFlex class="fake-input">
                    <span class="label">Tipo:</span>
                    <span class="value">{{datosArticulo.tipo_bien_servicio}}</span>
                </div>
                <div fxFlex class="fake-input">
                    <span class="label">Unidad de Medida:</span>
                    <span class="value">{{(datosArticulo.unidad_medida)?datosArticulo.unidad_medida:'Sin Asignar'}}</span>
                </div>
                <div fxFlex class="fake-input">
                    <span class="label">En Catalogo:</span>
                    <span class="value">{{ (datosArticulo.en_catalogo_unidad)?((datosArticulo.es_normativo)?'Normativo':'No Normativo'):'Fuera del Catalogo de la Unidad'}}</span>
                </div>
                <div fxFlex class="fake-input">
                    <span class="label">Cantidad Minima - Maxima:</span>
                    <span class="value">{{datosArticulo.cantidad_minima | number:'1.0-0'}} - {{datosArticulo.cantidad_maxima | number:'1.0-0'}}</span>
                </div>
            </mat-card>
        </div>
        <div fxFlex="none" style="padding:5px 0px;">
            <mat-divider></mat-divider>
        </div>
        <div fxFlex="none" fxLayout="row wrap">
            <div fxFlex="none" class="datos-almacen" *ngFor="let almacen of almacenes">
                <div fxLayout="row" class="detalles" matRipple [ngClass]="{'seleccionado':almacenSeleccionado.id == almacen.id}" (click)="seleccionarAlmacen(almacen)">
                    <div fxFlex fxLayout="column">
                        <div fxFlex class="nombre"><span>{{almacen.nombre}}</span></div>
                        <div fxFlex class="especificaciones" fxLayout="row">
                            <div fxFlex="none">{{almacen.tipo_almacen}} - {{(almacen.externo)?'Externo':'Interno'}}</div>
                            <div fxFlex>&nbsp;&nbsp;</div>
                            <div fxFlex="none">#Lotes: {{almacen.total_lotes}}</div>
                        </div>
                    </div>
                    <div fxFlex="none" class="existencias" fxLayout="row">
                        <div fxFlex><span class="existencia">{{+almacen.existencia | number:'1.0-0'}}</span> <span class="existencia-fraccion" *ngIf="+almacen.existencia_fraccion">({{+almacen.existencia_fraccion | number:'1.0-0'}})</span></div>
                        <div fxFlex class="resguardo" *ngIf="+almacen.resguardo">[ {{+almacen.resguardo | number:'1.0-0'}} <span *ngIf="+almacen.resguardo_fraccion">({{+almacen.resguardo_fraccion | number:'1.0-0'}})</span> ]</div>
                    </div>
                </div>
            </div>
        </div>
        <div fxFlex fxLayout="row" style="overflow: hidden;">
            <div fxFlex="none" fxLayout="column" class="lista-items">
                <div fxFlex="none" class="encabezado" fxLayout="row"><span fxFlex="none">Lotes:</span> <span fxFlex></span> <span fxFlex="none" *ngIf="dataSourceLotes">{{dataSourceLotes.filteredData.length}}/{{dataSourceLotes.data.length}}</span></div>
                <div fxFlex="none" fxLayout="row" class="campo-filtro">
                    <div fxFlex class="small-search-input">
                        <mat-form-field fxFlex appearance="outline">
                            <input matInput [(ngModel)]="filtroLotes" (keyup)="aplicarFiltroLotes($event)" placeholder="Filtrar" autocomplete="off" [disabled]="almacenSeleccionado.id == 0">
                        </mat-form-field>
                    </div>
                    <div fxFlex="none" style="padding: 10px 5px;">
                        <mat-checkbox [(ngModel)]="mostrarTodosLotes" (ngModelChange)="aplicarFiltroLotes()" [disabled]="almacenSeleccionado.id == 0"></mat-checkbox>
                    </div>
                </div>
                <div fxFlex class="lista">
                    <mat-selection-list #listaSeleccionableLotes [multiple]="false" (selectionChange)="seleccionarLote($event)">
                        <mat-list-option *ngIf="almacenSeleccionado.id == 0" disabled class="no-results-found">
                            Sin Almacén Seleccionado
                        </mat-list-option>
                        <mat-list-option *ngIf="isLoadingLotes" disabled class="no-results-found">
                            <div fxLayout="row">
                                <div fxFlex="none">
                                    <mat-spinner class="mini-spinner" [diameter]="20" [mode]="'indeterminate'"></mat-spinner>
                                </div>
                                <div fxFlex>
                                    Cargando Lotes . . .
                                </div>
                            </div>
                        </mat-list-option>
                        <mat-list-option *ngIf="almacenSeleccionado.id > 0 && !isLoadingLotes && dataSourceLotes.filteredData.length == 0" disabled class="no-results-found">
                            Sin Resultados
                        </mat-list-option>
                        <mat-list-option *ngFor="let lote of dataSourceLotes.filteredData" [value]="lote">
                            <mat-icon mat-list-icon matBadgePosition="before" matBadgeSize="small" matBadge="{{lote.movimientos}}" [matTooltip]="'Movimientos del Lote'">sync_alt</mat-icon>
                            <div mat-line><span class="lote-label">Lote: </span>{{lote.lote}}</div>
                            <div mat-line><span class="lote-label">Cad:</span> {{lote.fecha_caducidad | date}}</div>
                            <div mat-line>
                                <span class="lote-label">E:</span> {{lote.existencia | number:'1.0-0'}} <span *ngIf="lote.existencia_fraccion">({{lote.existencia_fraccion | number:'1.0-0'}})</span>
                                <span *ngIf="lote.resguardo"> | <span class="lote-label">R:</span> {{lote.resguardo | number:'1.0-0'}} <span *ngIf="lote.resguardo_fraccion">({{lote.resguardo_fraccion | number:'1.0-0'}})</span></span>
                            </div>
                        </mat-list-option>
                    </mat-selection-list>
                </div>
            </div>
            <div fxFlex fxLayout="column" class="item-detalles">
                <div fxFlex="none" class="encabezado">Detalles del Lote:</div>
                <div fxFlex="none" class="detalles-sin-lote" *ngIf="!loteSeleccionado">
                    <span>Seleccione un lote</span>
                </div>
                <div fxFlex="none" class="detalles-sin-lote" *ngIf="loteSeleccionado && isLoadingMovimientos">
                    <div fxLayout="row">
                        <div fxFlex></div>
                        <div fxFlex="none">
                            <mat-spinner class="mini-spinner" [diameter]="20" [mode]="'indeterminate'"></mat-spinner>
                        </div>
                        <div fxFlex="none">
                            Cargando detalles de movimientos . . .
                        </div>
                        <div fxFlex></div>
                    </div>
                </div>
                <div fxFlex fxLayout="column" class="detalles-lote" *ngIf="loteSeleccionado && !isLoadingMovimientos">
                    <mat-card fxFlex fxLayout="column">
                        <div fxFlex="none" fxLayout="row raw" fxLayoutGap="5px" class="datos-lote">
                            <div fxFlex class="fake-input">
                                <span class="label">Lote:</span>
                                <span class="value">{{datosLote.lote}}</span>
                            </div>
                            <div fxFlex class="fake-input">
                                <span class="label">Fecha de Caducidad:</span>
                                <span class="value">{{datosLote.fecha_caducidad | date:'MMMM d, y'}}</span>
                            </div>
                            <div fxFlex class="fake-input">
                                <span class="label">Código de Barras:</span>
                                <span class="value">{{datosLote.codigo_barras||'SC'}}</span>
                            </div>
                            <div fxFlex class="fake-input">
                                <span class="label">Detalle:</span>
                                <span class="value">{{datosLote.empaque_detalle||'Sin Detalles Asignados'}}</span>
                            </div>
                        </div>
                        <div fxFlex="none" fxLayout="row" fxLayoutAlign="center" class="bloques-detalles">
                            <div fxFlex="none" fxLayout="row" class="bloque bloque-movimientos">
                                <div fxFlex="none">
                                    <div class="etiqueta">Cant. Entrada:</div>
                                    <div class="datos">{{resumenMovimientos['ENT']['nrm'] | number:'1.0-0'}} <span *ngIf="resumenMovimientos['ENT']['uni'] > 0" MatTooltip="Piezas">[{{resumenMovimientos['ENT']['uni'] | number:'1.0-0'}} pzas.]</span></div>
                                </div>
                                <div fxFlex="none">
                                    <div class="etiqueta">Cant. Salida:</div>
                                    <div class="datos">{{resumenMovimientos['SAL']['nrm'] | number:'1.0-0'}} <span *ngIf="resumenMovimientos['SAL']['uni'] > 0" MatTooltip="Piezas">[{{resumenMovimientos['SAL']['uni'] | number:'1.0-0'}} pzas.]</span></div>
                                </div>
                            </div>
                            <div fxFlex="none" fxLayout="row" class="bloque bloque-existencias">
                                <div fxFlex="none">
                                    <div class="etiqueta">Disponible:</div>
                                    <div class="datos">{{existencias.cantidad | number:'1.0-0'}} <span *ngIf="existencias.piezas > 0" MatTooltip="Piezas">[{{existencias.piezas | number:'1.0-0'}} pzas.]</span></div>
                                </div>
                                <div fxFlex="none">
                                    <div class="etiqueta">Resguardado:</div>
                                    <div class="datos">{{resguardos.cantidad | number:'1.0-0'}} <span *ngIf="resguardos.piezas > 0" MatTooltip="Piezas">[{{resguardos.piezas | number:'1.0-0'}} pzas.]</span></div>
                                </div>
                                <div fxFlex="none" *ngIf="datosLote.resguardo_detalles_activos.length > 0">
                                    <button mat-icon-button cdkOverlayOrigin #botonInfoResguardos="cdkOverlayOrigin" (click)="verInfoResguardos = !verInfoResguardos"><mat-icon>info</mat-icon></button>
                                    <ng-template cdkConnectedOverlay [cdkConnectedOverlayOrigin]="botonInfoResguardos" [cdkConnectedOverlayOpen]="verInfoResguardos" yPosition="below" xPosition="before" (overlayOutsideClick)="verInfoResguardos = false">
                                        <mat-card class="lista-resguardos">
                                            <mat-list dense>
                                                <mat-list-item class="resguardo" *ngFor="let resguardo of datosLote.resguardo_detalles_activos">
                                                    <div class="usuario" mat-line [matTooltip]="resguardo.usuario.name" [matTooltipPosition]="'before'">{{resguardo.usuario.username}} :</div>
                                                    <div class="datos" mat-line>
                                                        {{resguardo.descripcion}} 
                                                        <span class="cantidad" [matTooltip]="'Cantidad restante'" [matTooltipPosition]="'after'">
                                                            ( {{resguardo.cantidad_restante | number:'1.0-0'}} <span *ngIf="resguardo.cantidad_piezas_restante">[{{resguardo.cantidad_piezas_restante | number:'1.0-0'}} Pzas.]</span> )
                                                        </span>
                                                    </div>
                                                    <div class="fecha" mat-line>{{resguardo.fecha_resguardo | date}}</div>
                                                    <mat-divider [inset]="true"></mat-divider>
                                                </mat-list-item>
                                            </mat-list>
                                        </mat-card>
                                    </ng-template>
                                </div>
                            </div>
                        </div>
                        <div fxFlex fxLayout="column">
                            <div fxFlex class="tabla-movimientos">
                                <table mat-table [dataSource]="dataSourceMovimientos" class="lista-movimientos-table" matSort>
                                    <ng-container matColumnDef="direccion_movimiento">
                                        <th mat-header-cell *matHeaderCellDef width="1" mat-sort-header> Estatus - Dirección </th>
                                        <td mat-cell *matCellDef="let row" class="{{listaEstatusClaves[row.estatus]}}-color">
                                            <mat-icon matTooltip="{{listaEstatusLabels[row.estatus]}}">{{listaEstatusIconos[row.estatus]}}</mat-icon>
                                            <mat-icon [matTooltip]="(row.direccion_movimiento == 'ENT')?'Entrada':'Salida'">{{(row.direccion_movimiento == 'ENT')?'exit_to_app':'launch'}}</mat-icon>
                                        </td>
                                    </ng-container>
            
                                    <ng-container matColumnDef="fecha_movimiento">
                                        <th mat-header-cell *matHeaderCellDef width="1" mat-sort-header> Fecha del Movimiento </th>
                                        <td mat-cell *matCellDef="let row">
                                            {{row.fecha_movimiento | date:'MMMM d, YYYY'}}
                                        </td>
                                    </ng-container>
            
                                    <ng-container matColumnDef="folio">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Folio </th>
                                        <td mat-cell *matCellDef="let row">
                                            {{row.folio}}<br>
                                            {{row.tipo_movimiento}}
                                        </td>
                                    </ng-container>
                                    
                                    <ng-container matColumnDef="destino_origen">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header fxHide.lt-lg> Destino | Origen </th>
                                        <td mat-cell *matCellDef="let row" style="white-space: nowrap; padding:0px 5px;" fxHide.lt-lg>
                                            {{(row.destino_origen)?row.destino_origen:'---'}}
                                        </td>
                                    </ng-container>
            
                                    <ng-container matColumnDef="modo_movimiento">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header width="1" style="white-space: nowrap; padding:0px 5px;"> Modo </th>
                                        <td mat-cell *matCellDef="let row" style="white-space: nowrap; padding:0px 5px; text-align: center;">
                                            {{row.modo_movimiento}}
                                        </td>
                                    </ng-container>
                
                                    <ng-container matColumnDef="cantidad">
                                        <th mat-header-cell *matHeaderCellDef mat-sort-header width="1" style="white-space: nowrap; padding:0px 5px;"> Cantidad </th>
                                        <td mat-cell *matCellDef="let row" style="white-space: nowrap; padding:0px 5px; text-align: center;">
                                            {{row.cantidad}}
                                        </td>
                                    </ng-container>
                                    
                                    <ng-container matColumnDef="noResultsFound">
                                        <td mat-footer-cell *matFooterCellDef [attr.colspan]="displayedColumns.length"> No se encontraron Movimientos </td>
                                    </ng-container>
            
                                    <ng-container matColumnDef="loadingData">
                                        <td mat-footer-cell *matFooterCellDef [attr.colspan]="displayedColumns.length"> Cargando Datos </td>
                                    </ng-container>
                                    
                                    <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                                    <tr mat-row class="tabla-row-articulo {{listaEstatusClaves[row.estatus]}}-color" *matRowDef="let row; let i = index; columns: displayedColumns;">
                                    <tr mat-footer-row *matFooterRowDef="['noResultsFound']" class="no-results-found" [ngClass]="{'hide': (dataSourceMovimientos && dataSourceMovimientos.filteredData.length > 0) || isLoadingMovimientos}"></tr>
                                    <tr mat-footer-row *matFooterRowDef="['loadingData']" class="no-results-found" [ngClass]="{'hide': !isLoadingMovimientos}"></tr>
                                </table>
                                <mat-progress-bar *ngIf="isLoadingMovimientos" mode="indeterminate" [color]="'accent'"></mat-progress-bar>
                            </div>
                            <div fxFlex="none" *ngIf="loteSeleccionado">
                                <mat-paginator [pageSize]="pageSize" [pageIndex]="currentPage" showFirstLastButtons></mat-paginator>
                            </div>
                        </div>
                    </mat-card>
                </div>
            </div>
        </div>
        <!--

                
            </div>
        </div-->
    </section>
</section>