<mat-drawer-container class="example-container" style="height: 100%; overflow: auto; flex: 1 1 0%;">
    <mat-drawer #entradaDrawer [mode]="'side'" style="min-width: 390px;">
        <mat-card fxFlex="100" fxLayout="column">
            <!--div class="data-loading-shade" *ngIf="isLoadingArticulos"><mat-spinner></mat-spinner></div>
            <div fxFlex fxLayout="column">
                <section fxFlex="none">
                    <div fxLayout="column">
                        <div fxFlex fxLayout="row wrap">
                            <mat-form-field fxFill appearance="outline">
                                <mat-label>Buscar</mat-label>
                                <input #busquedaInsumoQuery matInput [(ngModel)]="articuloQuery" (keyup.escape)="cleanSearch()" (keyup.enter)="buscarArticulos()" placeholder="Buscar">
                                <button matSuffix *ngIf="articuloQuery" mat-icon-button (click)="cleanSearch()" [attr.aria-label]="'Clean Query'" [attr.aria-pressed]="'cleanQuery'">
                                    <mat-icon>close</mat-icon>
                                </button>
                            </mat-form-field>
                        </div>
                        <button fxFlex mat-raised-button color="accent" (click)="buscarArticulos()" [disabled]="isLoadingArticulos">
                            <mat-icon>search</mat-icon> Buscar
                        </button>
                    </div>
                </section>
                <mat-divider [inset]="true"></mat-divider>
                <section fxFlex style="overflow: hidden;">
                    <cdk-virtual-scroll-viewport itemSize="222" style="overflow: auto; height: 100%;">
                        <div *cdkVirtualFor="let articulo of listadoArticulos;">
                            <div class="lista-articulos-item" [ngClass]="{'selected': articulo.id==idArticuloSeleccionado}">
                                <div class="lista-articulos-item-etiqueta articulo-bg-color">
                                    <div class="lista-articulos-item-etiqueta-icono">
                                        <span style="font-weight: bold;">Partida</span><br>
                                        <span>{{articulo.partida_clave}}</span>
                                    </div>
                                    <div class="lista-articulos-item-etiqueta-texto">
                                        {{articulo.familia}}
                                    </div>
                                </div>
                                <div class="lista-articulos-item-contenido">
                                    <div class="lista-articulos-item-cabecera">
                                        <div class="lista-articulos-item-cabecera-titulo">Clave: {{articulo.clave}}</div>
                                        <div class="lista-articulos-item-cabecera-subtitulo">{{articulo.descripcion}}</div>
                                    </div>
                                </div>
                                <div class="lista-articulo-item-acciones" fxLayout="row">
                                    <div fxFlex="none" style="padding: 6px 0px; width: 72px;">
                                        <mat-icon matTooltip="En Catalogo" *ngIf="articulo.en_catalogo" style="color:blue;">fact_check</mat-icon>
                                        <mat-icon matTooltip="Indispensable" *ngIf="articulo.indispensable" style="color:green;">notification_important</mat-icon>
                                        <mat-icon matTooltip="Descontinuado" *ngIf="articulo.descontinuado" style="color:red;">warning</mat-icon>
                                    </div>
                                    <div fxFlex style="padding: 8px 0px; text-align: center;">
                                        Existencias: 0
                                    </div>
                                    <button fxFlex="none" mat-flat-button (click)="agregarArticulo(articulo)">
                                        <mat-icon>{{(controlArticulosAgregados[articulo.id])?'edit':'add'}}</mat-icon>
                                    </button>
                                </div>
                            </div>
                            <mat-divider [inset]="true"></mat-divider>
                        </div>
                    </cdk-virtual-scroll-viewport>
                </section>
            </div-->
            <div fxFlex></div>
            <mat-divider [inset]="true"></mat-divider>
            <div fxFlex="none" fxLayout="row" style="padding-top:5px;">
                <div fxFlex="none">
                    <button mat-raised-button (click)="cerrarDrawer()"><mat-icon>chevron_left</mat-icon> Cerrar</button>
                </div>
                <div fxFlex></div>
            </div>
        </mat-card>
    </mat-drawer>
    <mat-drawer-content>
        <div class="data-loading-shade" *ngIf="isLoading"><mat-spinner></mat-spinner></div>
        <section fxLayout="column" fxLayoutGap="10px" fxLayoutAlign="start" style="padding:10px; height: 100%; overflow: auto; flex: 1 1 0%;">
            <section fxFlex="none" fxLayout="column">
                <div fxFlex="none" fxLayout="row" style="padding-right:4px;">
                    <button fxFlex="none" [routerLink]="'/almacen/entradas'" mat-stroked-button><mat-icon>backspace</mat-icon> Volver</button>
                    <button fxFlex="none" mat-button color="default" [matMenuTriggerFor]="menuMovimiento" aria-label="Menu de entrada">
                        <mat-icon>settings</mat-icon> Opciones <mat-icon>arrow_drop_down</mat-icon>
                    </button>
                    <div fxFlex>
                        <mat-progress-bar *ngIf="isLoading || isSaving" style="height:10px; padding-top: 15px;" mode="indeterminate" [color]="(isSaving)?'accent':'primary'"></mat-progress-bar>
                    </div>
                    <div fxFlex="none" fxLayout="column">
                        <div fxFlex fxLayout="row" class="estatus-pedido {{listaEstatusClaves[estatusMovimiento]}}-color">
                            <span fxFlex="none" style="padding-top:2px;"><mat-icon>{{listaEstatusIconos[estatusMovimiento]}}</mat-icon></span>
                            <span fxFlex="none" style="padding-top:5px;">{{listaEstatusLabels[estatusMovimiento]}}</span>
                        </div>
                    </div>
                </div>
                <mat-menu #menuMovimiento="matMenu">
                    <button mat-menu-item *ngIf="verBoton['guardar']" [disabled]="isSaving || !formMovimiento.valid" (click)="guardarMovimiento()" [class.button-spinner]="isSaving">
                        <mat-icon>save</mat-icon>
                        <span>Guardar</span>
                    </button>
                    <mat-divider></mat-divider>
                    <button mat-menu-item>
                        <mat-icon>outbox</mat-icon>
                        <span>Enviar a Revisión</span>
                    </button>
                    <button mat-menu-item *ngIf="verBoton['concluir']" [disabled]="isSaving || !formMovimiento.valid" (click)="concluirMovimiento()">
                        <mat-icon>all_inbox</mat-icon>
                        <span>Concluir Movimiento</span>
                    </button>
                    <mat-divider></mat-divider>
                    <button mat-menu-item>
                        <mat-icon>delete</mat-icon>
                        <span>Eliminar Entrada</span>
                    </button>
                    <button mat-menu-item>
                        <mat-icon>cancel</mat-icon>
                        <span>Cancelar Entrada</span>
                    </button>
                    <mat-divider></mat-divider>
                    <button mat-menu-item (click)="abrirDrawer()">
                        <mat-icon>tune</mat-icon>
                        <span>Firmas</span>
                    </button>
                    <button mat-menu-item>
                        <mat-icon>print</mat-icon>
                        <span>Imprimir</span>
                    </button>
                </mat-menu>
                <mat-card fxFlex fxLayout="row raw" fxLayoutAlign="space-between center" [formGroup]="formMovimiento" [style.fontSize.px]="15">
                    <mat-form-field fxFlex="none">
                        <mat-label>Fecha Entrada</mat-label>
                        <input matInput formControlName="fecha_movimiento" [max]="maxFechaMovimiento" [matDatepicker]="picker" required readonly>
                        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker #picker [disabled]="!editable"></mat-datepicker>
                        <mat-hint align="end">Click en icono para seleccionar</mat-hint>
                        <mat-error *ngIf="formMovimiento.get('fecha_movimiento').hasError('required')">Este campo es obligatorio</mat-error>
                    </mat-form-field>

                    <mat-form-field fxFlex>
                        <mat-label>Tipo de Entrada</mat-label>
                        <mat-select formControlName="tipo_movimiento_id">
                            <mat-option *ngIf="catalogos['tipos_movimiento'].length == 0">Sin Tipos de Movimiento</mat-option>
                            <mat-option *ngFor="let item of catalogos['tipos_movimiento']" [value]="item.id">
                                {{item.descripcion}}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                    <mat-form-field fxFlex>
                        <mat-label>Almacen</mat-label>
                        <mat-select formControlName="almacen_id" required>
                            <mat-option *ngIf="catalogos['almacenes'].length == 0">Sin Almacenes</mat-option>
                            <mat-option *ngFor="let item of catalogos['almacenes']" [value]="item.id">
                                {{item.nombre}}
                            </mat-option>
                        </mat-select>
                    
                    </mat-form-field>
                    
                    <mat-form-field fxFlex>
                        <mat-label>Programa</mat-label>
                        <input type="text" matInput formControlName="programa" [matAutocomplete]="autoProgramas">
                        <mat-autocomplete #autoProgramas="matAutocomplete" [displayWith]="getDisplayFn('descripcion')" panelWidth="auto">
                            <mat-option *ngIf="catalogos['programas'].length == 0" value="">No hay programas capturados</mat-option>
                            <mat-option *ngFor="let programa of filteredProgramas | async" [value]="programa">
                                {{programa.descripcion}}
                            </mat-option>
                        </mat-autocomplete>
                        <mat-hint *ngIf="formMovimiento.get('programa').value"><mat-icon>{{(formMovimiento.get('programa').value.id)?'check_box':'indeterminate_check_box'}}</mat-icon></mat-hint>
                    </mat-form-field>

                    <mat-form-field fxFlex>
                        <mat-label>No de Pedido</mat-label>
                        <input matInput formControlName="pedido_folio">
                        <mat-hint align="end">En caso de ser necesario</mat-hint>
                    </mat-form-field>

                    <mat-form-field fxFlex>
                        <mat-label>Proveedor</mat-label>
                        <input #proveedorInput type="text" matInput formControlName="proveedor" [matAutocomplete]="autoProveedores">
                        <mat-autocomplete #autoProveedores="matAutocomplete" [displayWith]="getDisplayFn('nombre')" panelWidth="auto">
                            <mat-option *ngFor="let proveedor of filteredProveedores | async" [value]="proveedor">
                                {{proveedor.nombre}} <mat-hint>[{{proveedor.rfc}}]</mat-hint>
                            </mat-option>
                        </mat-autocomplete>
                        <mat-hint *ngIf="formMovimiento.get('proveedor').value"><mat-icon>{{(formMovimiento.get('proveedor').value.id)?'check_box':'indeterminate_check_box'}}</mat-icon></mat-hint>
                        <mat-hint align="end" *ngIf="formMovimiento.get('proveedor').value">[{{formMovimiento.get('proveedor').value.rfc}}]</mat-hint>
                    </mat-form-field>

                    <mat-form-field fxFlex="none">
                        <mat-label>No de Referencia</mat-label>
                        <input matInput formControlName="referencia_folio">
                        <mat-hint align="end">Folio de Referencia o Factura</mat-hint>
                    </mat-form-field>

                    <mat-form-field fxFlex="none">
                        <mat-label>Fecha de Referencia</mat-label>
                        <input matInput formControlName="referencia_fecha" [max]="maxFechaMovimiento" [matDatepicker]="pickerReferencia" readonly>
                        <mat-datepicker-toggle matSuffix [for]="pickerReferencia"></mat-datepicker-toggle>
                        <mat-datepicker #pickerReferencia [disabled]="!editable"></mat-datepicker>
                        <mat-hint align="end">Click en icono para seleccionar</mat-hint>
                    </mat-form-field>

                    <mat-form-field fxFlex>
                        <mat-label>Observaciones</mat-label>
                        <textarea matInput formControlName="observaciones" rows="1" [readonly]="!editable"></textarea>
                    </mat-form-field>
                </mat-card>
            </section>
            <section fxFlex fxLayout="row" fxLayoutGap="10px">
                <section fxFlex="30" fxLayout="column">
                    <mat-card fxFlex="none" *ngIf="verBoton['agregar_articulos']" class="small-search-input agregar-articulos">
                        <mat-form-field appearance="outline" style="width: 100%;" [floatLabel]="'always'">
                            <mat-label>Buscador de Articulos</mat-label>
                            <input placeholder="Bucar Articulos" type="text" matInput [(ngModel)]="articuloQuery" [matAutocomplete]="autoArticulos">
                            <span matSuffix><mat-icon>manage_search</mat-icon></span>
                            <mat-autocomplete #autoArticulos="matAutocomplete" panelWidth="auto">
                              <mat-option *ngFor="let option of catalogos['proveedores']" [value]="option.nombre">
                                {{option.nombre}}
                              </mat-option>
                            </mat-autocomplete>
                        </mat-form-field>
                    </mat-card>
                    <mat-card fxFlex fxLayout="column">
                        <div fxFlex fxLayout="column"> <!-- Panel principal del pedido -->
                            <mat-chip-list aria-label="Pedido Interno">
                                <mat-chip color="primary" selected [disableRipple]="true">
                                    Total: {{ totalClavesRecibidas | number }} Claves [{{ totalArticulosRecibidos | number}} Articulos]
                                </mat-chip>
                            </mat-chip-list>
                        </div>
                    </mat-card>
                </section>
                <section fxFlex fxLayout="column">
                    <mat-card fxFlex="100" fxLayout="column">
                        <div fxFlex="none" fxLayout="row" style="padding-top:4px;">
                            <div fxFlex class="small-search-input">
                                <mat-form-field fxFlex appearance="outline">
                                    <input matInput [(ngModel)]="filtroArticulos" (keyup)="aplicarFiltroArticulos($event)" placeholder="Filtrar">
                                </mat-form-field>
                            </div>
                            <div fxFlex="none">
                                <button mat-flat-button (click)="limpiarFiltroArticulos()" [disabled]="!filtroAplicado">
                                    <mat-icon>filter_alt_off</mat-icon>
                                </button>
                            </div>
                        </div>
                        <mat-divider [inset]="true"></mat-divider>
                        <div fxFlex style="overflow: auto;">
                            <table mat-table [dataSource]="dataSourceArticulos" class="data-table" matSort multiTemplateDataRows>
                                
                                <ng-container matColumnDef="clave">
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header width="1"> Clave </th>
                                    <td mat-cell *matCellDef="let row" style="white-space: nowrap; padding:0px 5px;">
                                        {{(controlArticulosModificados[row.id])?controlArticulosModificados[row.id]:''}} {{row.clave}}
                                    </td>
                                </ng-container>
                                
                                <ng-container matColumnDef="nombre" >
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header fxHide.xs="true"> Nombre </th>
                                    <td mat-cell *matCellDef="let row" fxHide.xs="true"> {{row.nombre}} </td>
                                </ng-container>

                                <ng-container matColumnDef="no_lotes" >
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header fxHide.xs="true" width="1" style="text-align: center; white-space: nowrap;"> # Lotes </th>
                                    <td mat-cell *matCellDef="let row" fxHide.xs="true" width="1" style="white-space: nowrap; text-align: center;"> {{row.no_lotes | number:'1.0-0'}} </td>
                                </ng-container>
                                
                                <ng-container matColumnDef="total_piezas" >
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header fxHide.xs="true" width="1" style="text-align: center; white-space: nowrap;"> Cantidad </th>
                                    <td mat-cell *matCellDef="let row" fxHide.xs="true" width="1" style="white-space: nowrap; text-align: center;"> {{row.total_piezas | number:'1.0-0'}} </td>
                                </ng-container>

                                <ng-container matColumnDef="total_monto" >
                                    <th mat-header-cell *matHeaderCellDef mat-sort-header fxHide.xs="true" width="1" style="text-align: center; white-space: nowrap;"> Monto </th>
                                    <td mat-cell *matCellDef="let row" fxHide.xs="true" width="1" style="white-space: nowrap; text-align: center;"> ${{row.total_monto||0 | number:'1.0-2'}} </td>
                                </ng-container>

                                <ng-container matColumnDef="actions">
                                    <th mat-header-cell width="1" *matHeaderCellDef></th>
                                    <td mat-cell *matCellDef="let row; let i = index" width="1" style="white-space: nowrap;">
                                        <mat-icon>{{(idArticuloSeleccionado == row.id)?'unfold_less':'unfold_more'}}</mat-icon>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="expandedDetail">
                                    <td mat-cell *matCellDef="let articulo" [attr.colspan]="displayedColumns.length">
                                      <div class="articulo-detalle-listado-lotes" [@detailExpand]="articulo.id == idArticuloSeleccionado ? 'expanded' : 'collapsed'">
                                        <div class="articulo-listado-lotes">
                                            <div>
                                                {{articulo.descripcion}}
                                                <div>
                                                    <mat-icon matTooltip="En Catalogo" *ngIf="articulo.en_catalogo" style="color:blue;">fact_check</mat-icon>
                                                    <mat-icon matTooltip="Indispensable" *ngIf="articulo.indispensable" style="color:green;">notification_important</mat-icon>
                                                    <mat-icon matTooltip="Descontinuado" *ngIf="articulo.descontinuado" style="color:red;">warning</mat-icon>
                                                </div>
                                            </div>
                                            <div class="contenido-tabla-lotes">
                                                <table>
                                                    <thead>
                                                        <tr>
                                                            <th>Lote</th>
                                                            <th>Fecha Caducidad</th>
                                                            <th>Código de Barras</th>
                                                            <th>Cantidad</th>
                                                            <th *ngIf="puedeEditarElementos">Control</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr *ngFor="let lote of articulo.lotes">
                                                            <ng-container>
                                                                <td>{{lote.lote}}</td>
                                                                <td>{{lote.fecha_caducidad}}</td>
                                                                <td>{{lote.codigo_barras}}</td>
                                                                <td>{{lote.cantidad | number:'1.0-0'}}</td>
                                                                <td width="1" style="white-space: nowrap;" *ngIf="puedeEditarElementos">
                                                                    <button class="small-icon-button" mat-icon-button color="primary"><mat-icon>edit</mat-icon></button>
                                                                    <button class="small-icon-button" mat-icon-button color="warn"><mat-icon>delete</mat-icon></button>
                                                                </td>
                                                            </ng-container>
                                                        </tr>
                                                    </tbody>
                                                    <tfoot>
                                                        <tr *ngIf="puedeEditarElementos">
                                                            <ng-container>
                                                                <td colspan="5">
                                                                    <button class="medium-button" mat-button><mat-icon>add_circle</mat-icon> Agregar Lote</button>
                                                                </td>
                                                            </ng-container>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        </div>
                                      </div>
                                    </td>
                                </ng-container>
            
                                <ng-container matColumnDef="noResultsFound">
                                    <td mat-footer-cell *matFooterCellDef [attr.colspan]="displayedColumns.length">
                                        No se encontraron articulos 
                                    </td>
                                </ng-container>
                                
                                <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                                <tr mat-row class="tabla-row-articulo" *matRowDef="let row; let i = index; columns: displayedColumns;" 
                                    (click)="idArticuloSeleccionado = idArticuloSeleccionado === row.id ? null : row.id"
                                    [class.tabla-row-articulo-expandido]="idArticuloSeleccionado === row.id" >
                                </tr>
                                <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="tabla-row-articulo-detalle"></tr>
            
                                <tr mat-footer-row *matFooterRowDef="['noResultsFound']" class="not-results-found" [ngClass]="{'hide': dataSourceArticulos && dataSourceArticulos.filteredData.length > 0}"></tr>
                            </table>
                        </div>
                        <div fxFlex="none" fxLayout="row">
                            <div fxFlex="none" style="padding-top: 10px;">
                            </div>
                            <div fxFlex>
                                <!-- (page)="pageEvent = cargarPaginaArticulos($event)" -->
                                <mat-paginator [pageSize]="pageSize" [pageIndex]="currentPage" [pageSizeOptions]="pageSizeOptions" showFirstLastButtons></mat-paginator>
                            </div>
                        </div>
                    </mat-card>
                </section>
            </section>
        </section>
    </mat-drawer-content>
</mat-drawer-container>